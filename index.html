<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>תחרות ניקוד</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      direction: rtl;
    }
    .charts-container {
      display: flex;
      overflow-x: auto;
      gap: 20px;
    }
    .chart-box {
      width: 250px;
      min-width: 250px;
      height: 500px; /* גובה מוגדר כדי להבליט את העמודות */
    }
    canvas {
      height: 100% !important;
    }
  </style>
</head>
<body>
  <h2>תחרות ניקוד - הצגת תרשימים</h2>
  <input type="file" id="fileInput" accept=".csv" />
  <div class="charts-container" id="chartsContainer"></div>

  <script>
    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const data = parseCSV(text);
        renderCharts(data);
      };
      reader.readAsText(file);
    });

    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const result = [];

      for (let i = 1; i < lines.length; i++) {
        const [Chart_Title, Label_1, Value_1, Label_2, Value_2] = lines[i].split(",");

        const val1 = parseFloat(Value_1);
        const val2 = parseFloat(Value_2);
        const total = val1 + val2;

        result.push({
          title: Chart_Title,
          labels: [Label_1, Label_2, "סה\"כ"],
          values: [val1, val2, total]
        });
      }
      return result;
    }

    function renderCharts(chartsData) {
      const container = document.getElementById("chartsContainer");
      container.innerHTML = ""; // clear old charts

      // חישוב מקסימום כולל +10%
      let globalMax = 0;
      chartsData.forEach(chart => {
        const localMax = Math.max(...chart.values);
        if (localMax > globalMax) globalMax = localMax;
      });
      const yMax = Math.ceil(globalMax * 1.1);

      chartsData.forEach((chartData, index) => {
        const chartBox = document.createElement("div");
        chartBox.className = "chart-box";

        const canvas = document.createElement("canvas");
        canvas.id = "chart" + index;
        chartBox.appendChild(canvas);
        container.appendChild(chartBox);

        new Chart(canvas, {
          type: "bar",
          data: {
            labels: chartData.labels,
            datasets: [{
              label: chartData.title,
              data: chartData.values,
              backgroundColor: ["#4e79a7", "#f28e2b", "#59a14f"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: chartData.title,
                font: { size: 16 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: yMax
              }
            }
          }
        });
      });
    }
  </script>
</body>
</html>
